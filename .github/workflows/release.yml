name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build for ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: libdplyr
            asset_name: libdplyr-linux-x86_64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            artifact_name: libdplyr
            asset_name: libdplyr-linux-aarch64
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: libdplyr
            asset_name: libdplyr-macos-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: libdplyr
            asset_name: libdplyr-macos-aarch64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: libdplyr.exe
            asset_name: libdplyr-windows-x86_64.exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}
          override: true
          components: rustfmt, clippy

      - name: Install cross-compilation tools (Linux ARM64)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Configure cross-compilation (Linux ARM64)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          echo '[target.aarch64-unknown-linux-gnu]' >> ~/.cargo/config.toml
          echo 'linker = "aarch64-linux-gnu-gcc"' >> ~/.cargo/config.toml

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-

      - name: Build binary
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release --target ${{ matrix.target }}

      - name: Strip binary (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          if [ "${{ matrix.target }}" = "aarch64-unknown-linux-gnu" ]; then
            aarch64-linux-gnu-strip target/${{ matrix.target }}/release/${{ matrix.artifact_name }}
          else
            strip target/${{ matrix.target }}/release/${{ matrix.artifact_name }}
          fi

      - name: Prepare binary for upload
        shell: bash
        run: |
          mkdir -p artifacts
          cp target/${{ matrix.target }}/release/${{ matrix.artifact_name }} artifacts/${{ matrix.asset_name }}

      - name: Upload binary artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.asset_name }}
          path: artifacts/${{ matrix.asset_name }}

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f -ls

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          cat > release_notes.md << EOF
          # libdplyr ${VERSION}
          
          R dplyr ë¬¸ë²•ì„ SQL ì¿¼ë¦¬ë¡œ ë³€í™˜í•˜ëŠ” ê³ ì„±ëŠ¥ Rust ê¸°ë°˜ íŠ¸ëœìŠ¤íŒŒì¼ëŸ¬ì…ë‹ˆë‹¤.
          
          ## ğŸš€ ìƒˆë¡œìš´ ê¸°ëŠ¥
          
          - **stdin/stdout íŒŒì´í”„ë¼ì¸ ì§€ì›**: Unix íŒŒì´í”„ë¼ì¸ê³¼ ì™„ë²½ í†µí•©
          - **ë‹¤ì–‘í•œ ì¶œë ¥ í˜•ì‹**: JSON, Pretty, Compact í˜•ì‹ ì§€ì›
          - **ë¬¸ë²• ê²€ì¦ ëª¨ë“œ**: SQL ë³€í™˜ ì—†ì´ dplyr ë¬¸ë²• ê²€ì¦
          - **í–¥ìƒëœ ì˜¤ë¥˜ ì²˜ë¦¬**: ìƒì„¸í•œ ì˜¤ë¥˜ ë©”ì‹œì§€ì™€ í•´ê²° íŒíŠ¸
          - **í¬ë¡œìŠ¤ í”Œë«í¼ ì§€ì›**: Linux, macOS, Windows ë°”ì´ë„ˆë¦¬ ì œê³µ
          
          ## ğŸ“¦ ì§€ì› í”Œë«í¼
          
          - **Linux**: x86_64, ARM64 (aarch64)
          - **macOS**: Intel (x86_64), Apple Silicon (ARM64)
          - **Windows**: x86_64
          
          ## ğŸ›  ì„¤ì¹˜ ë°©ë²•
          
          ### ìë™ ì„¤ì¹˜ (ê¶Œì¥)
          
          \`\`\`bash
          # ìµœì‹  ë²„ì „ ì„¤ì¹˜
          curl -sSL https://raw.githubusercontent.com/libdplyr/libdplyr/main/install.sh | sh
          
          # íŠ¹ì • ë²„ì „ ì„¤ì¹˜
          LIBDPLYR_VERSION=${VERSION} curl -sSL https://raw.githubusercontent.com/libdplyr/libdplyr/main/install.sh | sh
          \`\`\`
          
          ### ìˆ˜ë™ ì„¤ì¹˜
          
          1. ì•„ë˜ì—ì„œ í”Œë«í¼ì— ë§ëŠ” ë°”ì´ë„ˆë¦¬ë¥¼ ë‹¤ìš´ë¡œë“œ
          2. ë°”ì´ë„ˆë¦¬ë¥¼ PATHì— í¬í•¨ëœ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          3. ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬: \`chmod +x libdplyr\`
          
          ## ğŸ“– ì‚¬ìš©ë²•
          
          \`\`\`bash
          # ê¸°ë³¸ ì‚¬ìš©ë²•
          echo "select(name, age) %>% filter(age > 18)" | libdplyr
          
          # SQL ë°©ì–¸ ì§€ì •
          echo "select(name)" | libdplyr -d mysql
          
          # ì¶œë ¥ í˜•ì‹ ì§€ì •
          echo "select(name)" | libdplyr --pretty
          echo "select(name)" | libdplyr --json
          
          # ë¬¸ë²• ê²€ì¦ë§Œ ìˆ˜í–‰
          echo "select(name, age)" | libdplyr --validate-only
          \`\`\`
          
          ## ğŸ”§ ì§€ì›ë˜ëŠ” dplyr í•¨ìˆ˜
          
          - \`select()\` - ì»¬ëŸ¼ ì„ íƒ
          - \`filter()\` - í–‰ í•„í„°ë§  
          - \`mutate()\` - ì»¬ëŸ¼ ìƒì„±/ìˆ˜ì •
          - \`arrange()\` - ì •ë ¬
          - \`group_by()\` - ê·¸ë£¹í™”
          - \`summarise()\` - ì§‘ê³„
          
          ## ğŸ—„ ì§€ì›ë˜ëŠ” SQL ë°©ì–¸
          
          - PostgreSQL (ê¸°ë³¸ê°’)
          - MySQL
          - SQLite
          - DuckDB
          
          ì „ì²´ ë¬¸ì„œëŠ” [GitHub ì €ì¥ì†Œ](https://github.com/libdplyr/libdplyr)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.
          EOF

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: libdplyr ${{ github.ref_name }}
          body_path: release_notes.md
          draft: false
          prerelease: false

      - name: Upload Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for dir in artifacts/*/; do
            if [ -d "$dir" ]; then
              asset_name=$(basename "$dir")
              asset_path="$dir$asset_name"
              if [ -f "$asset_path" ]; then
                echo "Uploading $asset_path as $asset_name"
                gh release upload ${{ github.ref_name }} "$asset_path" --clobber
              else
                echo "Warning: Asset file not found at $asset_path"
              fi
            fi
          done

  test-installation:
    name: Test Installation Script
    needs: release
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test installation script
        run: |
          # ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if [ -f "install.sh" ]; then
            echo "Testing installation script..."
            # ì‹¤ì œ ì„¤ì¹˜ëŠ” í•˜ì§€ ì•Šê³  ìŠ¤í¬ë¦½íŠ¸ ë¬¸ë²•ë§Œ í™•ì¸
            bash -n install.sh
            echo "Installation script syntax is valid"
          else
            echo "Warning: install.sh not found"
          fi

      - name: Test binary download (simulation)
        run: |
          VERSION=${{ github.ref_name }}
          echo "Testing binary download for version $VERSION"
          
          # í”Œë«í¼ ê°ì§€ í…ŒìŠ¤íŠ¸
          case "$(uname -s)" in
            Linux*)     platform="linux" ;;
            Darwin*)    platform="macos" ;;
            *)          echo "Unsupported OS"; exit 1 ;;
          esac
          
          case "$(uname -m)" in
            x86_64|amd64)   arch="x86_64" ;;
            aarch64|arm64)  arch="aarch64" ;;
            *)              echo "Unsupported arch"; exit 1 ;;
          esac
          
          binary_name="libdplyr-${platform}-${arch}"
          download_url="https://github.com/${{ github.repository }}/releases/download/${VERSION}/${binary_name}"
          
          echo "Would download: $download_url"
          
          # ì‹¤ì œ ë‹¤ìš´ë¡œë“œ í…ŒìŠ¤íŠ¸ (ë¦´ë¦¬ì¦ˆê°€ ì™„ë£Œëœ í›„)
          sleep 30  # ë¦´ë¦¬ì¦ˆ ì™„ë£Œ ëŒ€ê¸°
          if curl -f -L -o "/tmp/libdplyr-test" "$download_url"; then
            echo "Binary download successful"
            chmod +x "/tmp/libdplyr-test"
            if "/tmp/libdplyr-test" --version; then
              echo "Binary execution successful"
            else
              echo "Binary execution failed"
              exit 1
            fi
          else
            echo "Binary download failed"
            exit 1
          fi